<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Migration - ACSLite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 50px 0;
        }

        .migration-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .log-output {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
        }

        .success {
            color: #00ff00;
        }

        .error {
            color: #ff4444;
        }

        .info {
            color: #44aaff;
        }

        .warning {
            color: #ffaa00;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="migration-card p-5">
                    <div class="text-center mb-4">
                        <i class="fas fa-database fa-4x text-primary mb-3"></i>
                        <h2 class="fw-bold">Database Migration</h2>
                        <p class="text-muted">ACSLite - ONU Locations Table</p>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>This will create the <code>onu_locations</code> table in your database.</strong><br>
                        Safe to run multiple times (uses IF NOT EXISTS).
                    </div>

                    <div class="mb-4">
                        <h5 class="mb-3">Migration Steps:</h5>
                        <ol>
                            <li>Connect to database</li>
                            <li>Create <code>onu_locations</code> table</li>
                            <li>Add indexes for performance</li>
                            <li>Verify table structure</li>
                        </ol>
                    </div>

                    <div class="d-grid gap-2 mb-4">
                        <button class="btn btn-primary btn-lg" onclick="runMigration()">
                            <i class="fas fa-play me-2"></i>Run Migration
                        </button>
                    </div>

                    <div id="log-container" class="d-none">
                        <h5 class="mb-3">Migration Log:</h5>
                        <div class="log-output" id="log-output"></div>
                    </div>

                    <div id="result-container" class="d-none mt-4">
                        <!-- Results will be shown here -->
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a href="index.html" class="btn btn-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';

        function log(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const logContainer = document.getElementById('log-container');
            logContainer.classList.remove('d-none');

            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(line);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        async function runMigration() {
            const logOutput = document.getElementById('log-output');
            const resultContainer = document.getElementById('result-container');

            // Clear previous logs
            logOutput.innerHTML = '';
            resultContainer.innerHTML = '';
            resultContainer.classList.add('d-none');

            log('Starting database migration...', 'info');
            log('=========================================', 'info');

            try {
                // Call migration API
                log('Connecting to database...', 'info');

                const response = await fetch(`${API_BASE}/migrate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                log('Database connection successful!', 'success');
                log('Creating onu_locations table...', 'info');

                if (result.success) {
                    log('✓ Table created successfully!', 'success');
                    log('✓ Indexes added', 'success');
                    log('=========================================', 'info');
                    log('Migration completed successfully!', 'success');

                    // Show success result
                    resultContainer.innerHTML = `
                        <div class="alert alert-success">
                            <h5 class="alert-heading">
                                <i class="fas fa-check-circle me-2"></i>Migration Successful!
                            </h5>
                            <hr>
                            <p class="mb-0">
                                <strong>Table:</strong> onu_locations<br>
                                <strong>Status:</strong> Ready to use<br>
                                <strong>Records:</strong> ${result.count || 0}
                            </p>
                        </div>
                        <div class="card">
                            <div class="card-header bg-light">
                                <strong>Table Structure</strong>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Column</th>
                                            <th>Type</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>id</code></td>
                                            <td>INT</td>
                                            <td>Primary key (auto-increment)</td>
                                        </tr>
                                        <tr>
                                            <td><code>serial_number</code></td>
                                            <td>VARCHAR(50)</td>
                                            <td>ONU serial number (unique)</td>
                                        </tr>
                                        <tr>
                                            <td><code>name</code></td>
                                            <td>VARCHAR(100)</td>
                                            <td>Location name</td>
                                        </tr>
                                        <tr>
                                            <td><code>latitude</code></td>
                                            <td>DECIMAL(10,8)</td>
                                            <td>Latitude coordinate</td>
                                        </tr>
                                        <tr>
                                            <td><code>longitude</code></td>
                                            <td>DECIMAL(11,8)</td>
                                            <td>Longitude coordinate</td>
                                        </tr>
                                        <tr>
                                            <td><code>created_at</code></td>
                                            <td>TIMESTAMP</td>
                                            <td>Creation timestamp</td>
                                        </tr>
                                        <tr>
                                            <td><code>updated_at</code></td>
                                            <td>TIMESTAMP</td>
                                            <td>Last update timestamp</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    resultContainer.classList.remove('d-none');
                } else {
                    throw new Error(result.message || 'Migration failed');
                }

            } catch (error) {
                log('✗ Migration failed!', 'error');
                log(`Error: ${error.message}`, 'error');

                // Show error result
                resultContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h5 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>Migration Failed
                        </h5>
                        <hr>
                        <p class="mb-0">${error.message}</p>
                        <hr>
                        <p class="mb-0">
                            <strong>Troubleshooting:</strong><br>
                            1. Check if database is running<br>
                            2. Verify database credentials in .env<br>
                            3. Ensure you have CREATE TABLE permissions<br>
                            4. Check server logs for details
                        </p>
                    </div>
                `;
                resultContainer.classList.remove('d-none');
            }
        }
    </script>
</body>

</html>